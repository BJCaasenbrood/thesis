\vspace{-2mm}
\section{Nonlinear topology optimization}
\label{sec:C1:topo} 
The present study focuses on the solution scheme for nonlinear deformations in hyper-elastic continuum solids. To enhance this approach, we introduce a modification to the Finite Element Method (FEM) model, known as the Solid Isotropic Material With Penalization (SIMP) method. This method is a widely used material interpolation scheme in topology optimization \cite{Bendsoe2003,Gain2013Dec,Talischi2012Mar,Vasista2013Jul}. Subsequently, we elaborate on how the optimization problem can be formulated to generate topologies driven by soft fluidic actuation.

\subsection{Solid Isotropic Material With Penalization (SIMP)}
In the SIMP approach, each finite element $e \in \{1,2,...,n\}$ is assigned with a scalar density variable $\rho_e \in [0,1]$ to indicate if an elemental volume is solid ($\rho_e = 1$) or void ($\rho_e = 0$). This leads to a real-valued density field representing the material distribution within a discretized domain $\mathcal{B}_0$, where the global material distribution is represented by the density vector $\vec{\rho} = \left(\rho_1,\,\rho_2,\,...,\,\rho_{n}\right)^\top$. The density vector $\vec{\rho}$ then form the design variables of the optimization problem. To relate these artificial densities to elasticity, the strain energy density of the constitutive material model ${\Psi}$ is then parameterized using $\vec{\rho}$. To improve numerical robustness, a modified SIMP approach is used in which the strain-energy function is artificially modified as follows:
%
\begin{equation}
{\Psi}_e = [\,\varepsilon + (1-\varepsilon)\,{\rho_e}^p\,]\, {\Psi}, \label{eq:simp}
\end{equation}
%
where $p\ge 1$ is the penalty factor for penalizing intermediate densities during the optimization process, and $0 < \varepsilon \ll 1$ is a lower-bound on the material densities. In this work, we choose $p = 4$ and $\varepsilon = 10^{-3}$. Given the artificial elasticity model above, it shall be clear that residual vector in \eqref{eq:residual} now depends on the nodal displacements and the densities of the adaptive topology, $\boldsymbol{x}$ and $\boldsymbol{\rho}$, respectively.

\subsection{Artificial fluidic loads by elemental dilation}
The most general principle of actuation in soft robotics involves fluidic or pneumatic networks embedded into the elastic body. However, within the context of topology optimization, describing the internal pressure loads can be challenging. Unlike conventional optimization problems with static loads, in a pressure-based problem, the location, direction, and magnitude of the load change concerning the material distribution at every optimization step. This inherently yields design-dependency in the global force vector. To resolve this difficulty, we exploit the connectivity properties of polygonal tessellations to describe the physics involving pneumatics efficiently. Specifically, isolated regions of void polygonal elements will artificially mimic the geometrical loads in pneumatic actuation by dilation.

To identify void regions in the topology, we introduce the notion of a so-called "\emph{virus}" element whose purpose is to infect neighboring elements with a low elemental density (voids). These virus elements are chosen \textit{a-priori} and remain invariant, similar to the input of a pneumatic network. If the elements adjacent to an infected element have a density lower than a specified threshold $\gamma$, that is, $\rho_e < \gamma$, they become infected, and its infection rule will spread to its adjacent neighborhood. Afterwards, each infected element will be influenced by the same pneumatic load. Clearly, as the topological layout of the discretized domain $\mathcal{B}_0$ changes during the optimization procedure, the influence of the pneumatic load will vary accordingly. To better reflect the physics involving pneumatics, facial connectivity must be qualified for infection, where two elements must share a common edge to be adjacent, \ie, edge connection rather than node connection.


A flood-fill algorithm is used \cite{Chartrand1977Jan} to find the affected region of a virus element efficiently. In case of irregular tessellations, like the Voronoi tessellation, the flood-fill algorithm requires an adjacency matrix $\boldsymbol{\Gamma}$, which contains information about the mesh connectivity. The adjacency matrix can be directly computed from the element-node-incidence matrix. Here, the incidence matrix $\boldsymbol{A} \in \Z^{n\times m}$ is a sparse unit-matrix with $n$ columns for each element and $m$ rows for each node, where $\boldsymbol{A}_{ij} = 1$ iff node $i$ is incident upon element $j$, and otherwise zero. Given the incidence matrix, the adjacency matrix $\boldsymbol{\Gamma}\in \Z^{n\times n}$ can be computed by
%
\begin{equation}
\boldsymbol{\Gamma} = \boldsymbol{A}\boldsymbol{A}^\top - \text{diag}(\boldsymbol{A}\boldsymbol{A}^\top), \label{eq:adjecency}
\end{equation}
%
where the matrix has non-zero entries $\boldsymbol{\Gamma}_{ij} = 1,2$ iff elements $i$ and $j$ share a common node or edge, respectively. As mentioned earlier, the adjacency will be modified such that edge connectivity is required for adjacency. Secondly, all the rows and columns corresponding to elements that satisfy $\rho_e \ge \gamma$, given a predefined threshold $\gamma$, will be set to zero to ensure those elements are unaffected by the flood-fill. The pseudo-code for the identification of the pneumatic region is provided in Algorithm \ref{alg:floodfill}.

\begin{algorithm}[!t]
    \SetKwInOut{Input}{Input}
    \SetKwInOut{Output}{Output}
    \Input{Tessellation $\mathcal{T}$, set of virus elements $\mathcal{V}$, threshold $\gamma$, material density vector $\boldsymbol{\rho}$}
    \Output{Set of elemental indices $\mathcal{E}$}
    construct $\boldsymbol{\Gamma}  \gets {\texttt{BuildAdjacencyMatrix}}(\mathcal{T})$\;
    modify $\boldsymbol{\Gamma}  \gets {\texttt{EdgeConnectivity}}(\boldsymbol{\Gamma})$\;
    find thresholds $\mathcal{X} = \{\, i \in [1,n_e] \;|\; \rho_i \ge \gamma \,\}$\;
    set zeros $\boldsymbol{\Gamma}_i = (\boldsymbol{\Gamma}^\top)_i = 0$ for all $i \in  \mathcal{X}$\;
    initialize empty set $\mathcal{E} \gets \emptyset$\;
  \For{$i = 1: \textrm{numVirus} $}{{}
  $\mathcal{I} \gets {\texttt{doFloodFill}}(\boldsymbol{\Gamma},\mathcal{V}_i)$\;
  %$\text{bool} \gets \textbf{isEnclosed}(\mathcal{I})$\;
        $\mathcal{E} \gets \mathcal{E} \cup \mathcal{I}$\;
  }
    \caption{Find elements subjected to volumetric deformation \label{alg:floodfill}}
\end{algorithm}

From a mathematical perspective, let us consider Algorithm \ref{alg:floodfill}, which can be represented by a mapping $\phi: \mathbb{R}^{n} \to \mathbb{Z}$. Here, the mapping $\phi(\boldsymbol{\rho})$ returns a set of elemental indices of infected elements denoted by $\mathcal{E} \subseteq \{1,2,...,n\}$ that undergo volumetric compression or expansion based on boundary conditions. Using this mapping, we can assemble the global force matrix $\boldsymbol{f}$ in Equation \eqref{eq:residual} from the elemental force vectors of the affected region of the virus element $\mathcal{E}$:
%
\begin{equation}
%\boldsymbol{f}(\boldsymbol{x},\boldsymbol{\rho}) = \sum_{e \in \mathcal{E}} \tilde{p}_n \boldsymbol{W}_{\!e} \boldsymbol{K}_e \boldsymbol{n}_e, \label{eq:pressureforce}
\fB_{\textrm{ext}}(\boldsymbol{x},\boldsymbol{\rho}) = \sum_{e \in \mathcal{E}} \tilde{p}_e \boldsymbol{W}_{\!e} \, \boldsymbol{t}_{e}, \label{eq:pressureforce}
\end{equation}
%
where $\tilde{p}_e$ is a dimensionless parameter that represents the magnitude and direction of artificial pneumatic loading. $\boldsymbol{W}_{\!e}$ is a diagonal weighting matrix of densities at nodal level, and $\boldsymbol{t}_e = \int_{\mathcal{V}_e} \BB_e^\top \DB_e \nB_v \; dV$ is the elemental force vector. The volumetric strain is represented by $\boldsymbol{n}_{v} = (1,1,0)^\top$, and $\DB_e := \p \underline{\ten{S}}_{e}/\p \ten{E}$ is the fourth-order constitutive stress-strain stiffness tensor in matrix notation \cite{Renaud2011}. The derivation of $\mathbb{D}_e$ is found in Appendix \ref{app:C3:yeohmodel}. It is important to note that the global force vector in \eqref{eq:pressureforce} represents an artificial pneumatic load. This method assumes that pressure loads can be emulated by anisotropic volumetric change of the polygonal elements. By varying the dimensionless parameter $\tilde{p}_e$, the magnitude and direction of this artificial pneumatic load can be controlled.

\subsection{Optimization problem}
Given the concept of morphology in soft robotics, which is similar to compliant mechanisms, the primary goal is to maximize the output displacement $\boldsymbol{x}_{\textrm{out}}$ on a virtual workpiece modeled by an artificial stiffness $k_{\textrm{out}} > 0$ \cite{Bendsoe2003,Gain2013Dec}. The objective function or the desired output displacement can be expressed as $\Phi = \boldsymbol{L}^\top\boldsymbol{x}(\boldsymbol{\rho})$, where $\boldsymbol{L} \in \R^{2n}$ is a sparse vector composed of non-zero entries for the degrees-of-freedom corresponding to the desired morphology of the soft robot. Given this description of directional output displacement, the topology optimization problem for soft robots can be formulated as:
\begin{equation}
\begin{aligned}
\max_{\boldsymbol{\rho}} \quad &  \Phi = \boldsymbol{L}^\top \boldsymbol{x}(\boldsymbol{\rho}), \\
\textrm{s.t.} \quad & c:=\boldsymbol{r}(\boldsymbol{x},\boldsymbol{\rho}) \,= \,0,\\
& g:=\boldsymbol{v}^\top \boldsymbol{\rho}  \le V^\star, \\
  &\boldsymbol{\rho} \in \mathcal{P},
  \label{eq:opt}
\end{aligned}
\end{equation}
where $\boldsymbol{r} \in \R^{2n}$ the global residual force vector in its equilibrium state, $\boldsymbol{v} \in \R^{n_e}$ a constant vector of relative elemental volumes, $ 0 < V^\star < 1$ the desired material infill, and $\mathcal{P} = \{\boldsymbol{\rho} \in \R^{n_e} \; | \; 0  \le \rho_e \le 1 \; \forall e \in [1,n_e] \}$ a set of feasible material densities that ensure numerical robustness.

\subsection{Solver and sensitivity analysis}
In this section, we discuss the use of a gradient-based optimization solver for synthesizing the soft robot. Here, we use the Method of Moving Asymptotes (MMA) proposed by Svanberg \cite{Svanberg1987Feb}. The MMA is similar to other nonlinear programming approaches, such as Optimality Criteria (OC) and Sequential Quadratic Programming (SQP), in that it finds an optimal solution to a nonlinear non-convex optimization problem with inequality constraints. The MMA solves a sequence of sub-problems, \ie, convex approximations of the true problem, which are constructed from gradient-based information of the objective function $\Phi$ and their constraints $c$ and $g$. Svanberg \cite{Svanberg1987Feb} has provided open numerical implementations for his MMA algorithm represented as MATLAB function called \texttt{mmasub}, which is subroutine of the MMA algorithm that updates the design parameters $\vec{\rho}^{(k)} \to \vec{\rho}^{(k+1)}$ given the design sensitivities of the objective $\Phi$ and the equality and inequality constraints $c$ and $g$, respectively. By recursively calling \texttt{mmasub}, the optimization problem in \eqref{eq:opt} can be solved numerically.

The sensitivity of the inequality constraint in \eqref{eq:opt} is ${\partial g}/{\partial \boldsymbol{\rho}} = \boldsymbol{v}$ since we assume that the elemental volume $\boldsymbol{v}$ is constant. The sensitivity of the objective function is less trivial due to its dependency on the nodal displacements $\boldsymbol{x}(\boldsymbol{\rho})$. Since it is computationally expensive to obtain the displacements $\boldsymbol{x}$ through the Newton-Raphson method, it becomes beneficial to avoid the computation of their sensitivities. Thus, the sensitivities are computed through the adjoint method in which the objective function is augmented to include the equality constraint $c$. This leads to
%
\begin{equation}
{\Phi}(\xB,\vec{\rho}) = \boldsymbol{L}^\top \boldsymbol{x}(\vec{\rho}) - \boldsymbol{\lambda}^\top \boldsymbol{r}(\xB,\vec{\rho}),
\end{equation}
%
where $\boldsymbol{\lambda} \in \R^{2n}$ is a constant vector referred to as the adjoint vector. Note that, in case of equilibrium (\ie, $\boldsymbol{r} = \vec{0}_n$), the global residual forces are equivalent to zero; therefore, the adjoint vector can be chosen freely without violating the original optimization problem. 
%For the sake of brevity, we denote differentiations by $\p(\cdot)/\p x := (\cdot),_{x}$. 
Differentiations of the objective function with respect to the elemental densities $\rho_e$ for each finite element $e \in \{1,2,...,n_e\}$ yields
%
\begin{align}
\frac{\p \Phi}{\p {\rho_e}} & = \,\boldsymbol{L}^\top \frac{\p \x}{\p \rho_e} - \boldsymbol{\lambda}^\top\left( \left[ \frac{\p \rB}{\p x_1} \;\hdots\; \frac{\p \rB}{\p x_n} \right] \!\frac{\p \x}{\p \rho_e} + \frac{\p \boldsymbol{r}}{ \p \rho_e} \right), \notag \\[0.75em]
 & = \left(\boldsymbol{L}^\top - \boldsymbol{\lambda}^\top \boldsymbol{K}_T \right) \frac{\p \boldsymbol{x}}{\p \rho_e} - \boldsymbol{\lambda}^\top \frac{\p \boldsymbol{r}}{\p \rho_e},  \label{eq:sen_deriv} 
\end{align}
%
\noindent where the Jacobian of the residual force vector is substituted by the tangent stiffness matrix $\KB_T$, see Appendix \ref{app:C3:yeohmodel} for the derivation. By choosing the adjoint vector $\boldsymbol{\lambda} = (\boldsymbol{K}_T)^{-\top}\boldsymbol{L}$, the terms involving ${\p \x}/{\p \rho_e}$ can be eliminated and thus computation of the gradient becomes feasible. Following this, the gradient of the objective function can be written compactly as:
%
\begin{align}
\frac{\p {\Phi} }{\p \rho_e} \overset{\eqref{eq:residual}}{=} -\boldsymbol{L}^\top(\boldsymbol{K}_T)^{-1} \left( \sum_{e=1}^{n_e} \int_{\mathcal{V}_e} \boldsymbol{B}_e^\top \frac{\p \underline{\ST}_e}{\p {\rho_e}} \; dV - \frac{ \p \fB_{\textrm{ext}}}{\p {\rho_e}}  \right). \label{eq:sens_f}
\end{align} 
%

\noindent However, it should be noted that deriving the loading sensitivity $\p \boldsymbol{f}_{\textrm{ext}}/\p \rho_e$ is not straightforward since the global force vector is constructed from nested functions of logic operations such as flood-fill. Therefore, we derive the loading sensitivity numerically using the forward difference method. To reduce computation time, we propose computing the sensitivities of only the elements at the boundary of the pressure region since the gradient of the pneumatic region is largest near the boundary of the infected set $\mathcal{E}$. We provide pseudo-code for the computational design algorithm for synthesizing pressure-driven soft robots in Algorithm \ref{alg:topology_opt}. 

\begin{algorithm}[!t]
  \SetKwInOut{Input}{Input}
  \SetKwInOut{Output}{Output}
  \Input{Domain $\mathcal{B}_0$, material $\Psi$, initial $\boldsymbol{\rho}^{(0)}$, infill $V^*$, virus $\mathcal{V}$, output $\boldsymbol{L}$, artificial pressure $\tilde{p}_e$ }
  \Output{Optimal soft robot topology $\boldsymbol{\rho}^*$}
  construct tessellation $\mathcal{T} \gets {\texttt{VoronoiMesher}}(\mathcal{B}_0)$\;
  \While{$\text{convergence} \neq 1 $}{
  update artificial material $\Psi_e$ using \eqref{eq:simp} \;
  find infected set $\mathcal{E}$ using \textbf{Algorithm 1} \;
  build residual forces $\boldsymbol{R}$ using \eqref{eq:residual} and \eqref{eq:pressureforce}\; 
  solve displacements $\boldsymbol{x} \gets \texttt{NewtonRaphson}(\boldsymbol{R})$ \;
  evaluate $g,_{\boldsymbol{\rho}} \gets \p g/\p{{\rho}_e}$ \;
  evaluate $\Phi,_{\boldsymbol{\rho}} \gets\p\Phi/\p{{\rho}_e}$ using \eqref{eq:sens_f} \; 
  update $\boldsymbol{\rho} \gets \texttt{MMA}(\Phi,_{\boldsymbol{\rho}},g,_{\boldsymbol{\rho}},\boldsymbol{\rho})$ \;
  }
  \caption{Computational design algorithm for pneumatic soft robots.\label{alg:topology_opt}}
\end{algorithm}
\clearpage

\subsection{Gradient filters and interpolation}
A well-known filtering technique is used to solve this issue, which has been proposed by Sigmund et al. \cite{Bendsoe2003}. The design sensitivities are modified based on a weighted average filtering scheme \cite{Gain2013Dec,Bendsoe2003}:
%
\begin{equation}
\frac{\p \tilde{\Phi}}{\p {\rho_e}} = \frac{1}{\rho_e \sum^n_{i=1} H_{e,i}} \sum^n_{i=1} H_{e,i} \,\rho_i \frac{\p {\Phi}}{\p {\rho_i}},
\label{eq:C3:filters}
\end{equation}
%
where $H_{e,i} := \textrm{max} \left\{0, R_{\textrm{min}} - \Delta(\pB_e,\pB_i)\right\}$ is the filter weight, $R_{\textrm{min}}$ is the filter radius, and $\Delta(\pB_e,\pB_i)$ is the Euclidean distance between the centers of the elements $i$ and $e$. The radial filtering is solely applied to the design sensitivities, and therefore, the polygonal mesh discretization heavily influences the final topology design. In order to improve the quality of optimization output, we implement Radial Basis Functions (RBF) interpolation that is weighted with filter densities. This is followed by an isosurface extraction process that aids in achieving a distinct separation between void and filled regions. Mathematically, the filter topology of the optimization routine is given by 
%
\begin{equation}
\mathcal{B}^\star = \Big\{ \XB \in \mathcal{B}_0 ~
|~ \sum_{e=1}^{n} \psi_{\textrm{RBF}}(\XB - \pB_e; \rho_e) \ge \epsilon_\textrm{iso}\Big\}
\end{equation}
%
where we explore a radial interpolation function $\psi_{\textrm{RBF}}(\rB; \rho) = \exp\left( - \alpha \rho \lVert\rB\rVert^2 \right)$ with $\alpha > 0$ a tuning parameter, and $\epsilon_{\textrm{iso}}$ is the isosurface value. The parameter $\alpha$ enables users to regulate the thickness (or radial dilation) of the optimized soft topology. For our specific investigation, we opt to use $\alpha = R_\textrm{min}$ as a means of aligning with the filter radius specified in \eqref{eq:C3:filters}. In Figure \ref{fig:C3:topo_filtering}, we show this multi-step filtering scheme which is employed to reduce the tessellation artifacts on the topology optimization solutions.

\begin{figure}[!t]
  \centering
  \vspace{-2mm}
  \input{./pdf/thesis-figure-3-1.pdf_tex}
  \caption{\small An illustration of filter and interpolation schemes developed to minimize mesh artifacts. The areas (\textcolor{matinfil}{$\blacksquare$}, \textcolor{lightvoid}{$\blacksquare$}) denote the material infill and void regions, respectively. (a) The ground truth. (b) Density field based on the piecewise Voronoi tessellation. Note the jitter around the boundaries of the material infill, which leads to high sharp gradients in ${\partial \phi}/{\partial \rho_e}$. (c) To address this issue, filtered densities are obtained using \eqref{eq:C3:filters}. (d) The isosurface reconstruction $\mathcal{B}^\star$ of the filtered density field of the optimizer.}
  \label{fig:C3:topo_filtering}
\end{figure}

